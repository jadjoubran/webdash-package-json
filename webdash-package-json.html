<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="bower_components/paper-spinner/paper-spinner.html">

<dom-module id="webdash-package-json">
  <template>
    <style>
      :host {
        display: block;
      }

      .spinner {
        width: 20px;
        height: 20px;
      }
    </style>

    <h1>Packages</h1>

    <template id="packages" is="dom-repeat" items="{{packages}}">
      <div>
        {{item.name}}: {{item.version}}
        <template is="dom-if" if="{{item.latest}}">
          <small>({{item.latest}})</small>
          <span on-click="_update">
            <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 433.5 433.5">
              <path d="M395.25 153h-102V0h-153v153h-102l178.5 178.5L395.25 153zm-357 229.5v51h357v-51h-357z" id="file-download" />
            </svg>
          </span>
          <paper-spinner class="spinner"></paper-spinner>
        </template>
      </div>
    </template>
  </template>

  <script>
    /**
     * `webdash-package-json`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class WebdashPackageJson extends Polymer.Element {
      static get is() { return 'webdash-package-json'; }

      ready() {
        super.ready();

        this._getPackages();
      }

      _getPackages() {
        backend.get('webdash-package-json/package-json')
          .then(data => {
            if (!data.result) {
              return false;
            }

            const packages = [];
            for (const [key, value] of Object.entries(data.result)) {
              packages.push({ name: key, version: value.version });
            }
            this.packages = packages;
            this._getOutated();
          })
          .catch(console.error);
      }

      _getOutated() {
        backend.get('webdash-package-json/outdated')
          .then(data => {
            if (!data.result) {
              return false;
            }
            const outdated = [];
            for (const [key, value] of Object.entries(data.result)) {
              outdated.push({ name: key, ...value });
            }

            this.packages.forEach((pkg, index) => {
              let newer = outdated.find(p => p.name === pkg.name);
              if (newer) {
                if (newer.current !== newer.wanted) {
                  this.set(`packages.${index}.latest`, newer.latest);
                  pkg.latest = newer.latest;
                }
              }
            });
          })
          .catch(console.error);
      }

      async _update(event) {
        const spinner = event.currentTarget.nextElementSibling;
        spinner.active = true;
        event.currentTarget.remove();
        backend.post('webdash-package-json/update', {
          name: event.model.item.name
        })
          .then(data => {
            if (!data.result) {
              return false;
            }
            this._getPackages();
          })
          .catch((err) => {
            console.error(err);
          })
          .finally(() => {
            spinner.active = false;
          });
      }
    }

    window.customElements.define(WebdashPackageJson.is, WebdashPackageJson);
  </script>
</dom-module>